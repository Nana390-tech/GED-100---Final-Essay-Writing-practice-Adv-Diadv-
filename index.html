!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Essay Builder - Advantage & Disadvantage Essays</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container { max-width: 900px; margin: 0 auto; }
        .header {
            background: white; border-radius: 16px; padding: 30px; text-align: center;
            margin-bottom: 24px; box-shadow: 0 8px 32px rgba(0,0,0,0.15);
        }
        .header h1 {
            font-size: 2rem; background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 8px;
        }
        .header p { color: #6b7280; font-size: 1rem; }
        .header .badge {
            display: inline-block; background: #ede9fe; color: #7c3aed;
            padding: 4px 14px; border-radius: 20px; font-size: 0.85rem; font-weight: 600; margin-top: 10px;
        }
        .topics-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 16px; margin-bottom: 24px;
        }
        .topic-card {
            background: white; border-radius: 14px; padding: 22px 18px; text-align: center;
            cursor: pointer; transition: all 0.3s ease; box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            border: 3px solid transparent;
        }
        .topic-card:hover { transform: translateY(-4px); box-shadow: 0 8px 24px rgba(0,0,0,0.15); }
        .topic-card .emoji { font-size: 2.2rem; margin-bottom: 10px; display: block; }
        .topic-card .title { font-weight: 700; color: #1f2937; font-size: 0.95rem; }
        .topic-card:nth-child(1) { border-top: 4px solid #ef4444; }
        .topic-card:nth-child(2) { border-top: 4px solid #f59e0b; }
        .topic-card:nth-child(3) { border-top: 4px solid #3b82f6; }
        .topic-card:nth-child(4) { border-top: 4px solid #10b981; }
        .topic-card:nth-child(5) { border-top: 4px solid #8b5cf6; }
        .topic-card:nth-child(6) { border-top: 4px solid #ec4899; }
        .topic-card:nth-child(7) { border-top: 4px solid #14b8a6; }
        .topic-card:nth-child(8) { border-top: 4px solid #f97316; }
        .writing-panel {
            background: white; border-radius: 16px; padding: 30px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.15); margin-bottom: 24px;
        }
        .writing-panel h2 { font-size: 1.4rem; color: #1f2937; margin-bottom: 6px; }
        .topic-label { color: #7c3aed; font-weight: 600; font-size: 1rem; margin-bottom: 16px; }
        .instructions {
            background: #fef3c7; border-left: 4px solid #f59e0b; padding: 14px 18px;
            border-radius: 8px; margin-bottom: 18px; font-size: 0.92rem; color: #92400e; line-height: 1.6;
        }
        .essay-textarea {
            width: 100%; min-height: 280px; border: 2px solid #e5e7eb; border-radius: 12px;
            padding: 16px; font-size: 1rem; line-height: 1.7; resize: vertical;
            font-family: inherit; transition: border-color 0.3s;
        }
        .essay-textarea:focus { outline: none; border-color: #7c3aed; }
        .word-count { text-align: right; margin-top: 8px; font-size: 0.88rem; color: #6b7280; }
        .word-count.low { color: #ef4444; }
        .word-count.good { color: #10b981; }
        .btn-row { display: flex; gap: 12px; margin-top: 18px; flex-wrap: wrap; }
        .btn {
            padding: 12px 28px; border: none; border-radius: 10px; font-size: 1rem;
            font-weight: 600; cursor: pointer; transition: all 0.3s;
            display: inline-flex; align-items: center; gap: 8px;
        }
        .btn:hover { transform: translateY(-2px); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        .btn-primary { background: linear-gradient(135deg, #7c3aed, #6366f1); color: white; }
        .btn-primary:hover:not(:disabled) { box-shadow: 0 6px 20px rgba(124,58,237,0.4); }
        .btn-green { background: linear-gradient(135deg, #10b981, #059669); color: white; }
        .btn-green:hover:not(:disabled) { box-shadow: 0 6px 20px rgba(16,185,129,0.4); }
        .btn-gray { background: #e5e7eb; color: #374151; }
        .btn-gray:hover:not(:disabled) { background: #d1d5db; }
        .btn-print { background: linear-gradient(135deg, #3b82f6, #2563eb); color: white; }
        .btn-print:hover:not(:disabled) { box-shadow: 0 6px 20px rgba(59,130,246,0.4); }
        .feedback-panel {
            background: white; border-radius: 16px; padding: 30px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.15); margin-bottom: 24px;
        }
        .feedback-panel h2 { font-size: 1.4rem; color: #1f2937; margin-bottom: 18px; }
        .feedback-section {
            background: #f9fafb; border-radius: 12px; padding: 20px; margin-bottom: 16px;
        }
        .feedback-section h3 {
            font-size: 1.05rem; margin-bottom: 10px;
            display: flex; align-items: center; gap: 8px;
        }
        .feedback-section p, .feedback-section div.fb-text {
            font-size: 0.95rem; color: #374151; line-height: 1.7;
        }
        .grammar-section h3 { color: #dc2626; }
        .vocab-section h3 { color: #2563eb; }
        .task-section h3 { color: #059669; }
        .tips-section h3 { color: #d97706; }
        .score-bar {
            width: 100%; height: 10px; background: #e5e7eb;
            border-radius: 8px; margin-top: 8px; overflow: hidden;
        }
        .score-fill { height: 100%; border-radius: 8px; transition: width 0.5s ease; }
        .score-fill.red { background: #ef4444; }
        .score-fill.yellow { background: #f59e0b; }
        .score-fill.green { background: #10b981; }
        .error-highlight {
            background: #fef2f2; border: 1px solid #fecaca; border-radius: 6px;
            padding: 10px 14px; margin: 8px 0; font-size: 0.9rem;
        }
        .error-highlight .original { color: #dc2626; text-decoration: line-through; }
        .error-highlight .correction { color: #059669; font-weight: 600; }
        .error-highlight .explain { color: #6b7280; font-style: italic; font-size: 0.85rem; }
        .vocab-suggestion {
            background: #eff6ff; border: 1px solid #bfdbfe; border-radius: 6px;
            padding: 10px 14px; margin: 8px 0; font-size: 0.9rem;
        }
        .vocab-suggestion .used { color: #6b7280; }
        .vocab-suggestion .better { color: #2563eb; font-weight: 600; }
        .task-check { padding: 6px 0; font-size: 0.95rem; }
        .task-check.pass { color: #059669; }
        .task-check.fail { color: #dc2626; }
        .sample-panel {
            background: white; border-radius: 16px; padding: 30px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.15); margin-bottom: 24px;
        }
        .sample-panel h2 { font-size: 1.4rem; color: #1f2937; margin-bottom: 18px; }
        .sample-essay {
            background: #f0fdf4; border-left: 4px solid #10b981; padding: 20px;
            border-radius: 8px; font-size: 0.95rem; line-height: 1.8; color: #1f2937; white-space: pre-wrap;
        }
        .back-link {
            color: white; font-size: 0.95rem; cursor: pointer;
            margin-bottom: 12px; display: inline-flex; align-items: center; gap: 6px; opacity: 0.9;
        }
        .back-link:hover { opacity: 1; text-decoration: underline; }
        .warning-box {
            background: #fef2f2; border: 2px solid #fca5a5; border-radius: 14px;
            padding: 28px; margin-bottom: 24px; text-align: center;
        }
        .warning-box .icon { font-size: 2.5rem; margin-bottom: 12px; }
        .warning-box h2 { color: #dc2626; font-size: 1.3rem; margin-bottom: 12px; }
        .warning-box p { color: #7f1d1d; line-height: 1.7; font-size: 0.95rem; margin-bottom: 8px; }
        .warning-box .issues { background: white; border-radius: 8px; padding: 16px; margin: 14px 0; text-align: left; }
        .warning-box .issues li { color: #991b1b; margin-bottom: 6px; font-size: 0.93rem; list-style: none; padding-left: 24px; position: relative; }
        .warning-box .issues li::before { content: '‚ö†Ô∏è'; position: absolute; left: 0; }
        .warning-box .help-box { background: #f0fdf4; border: 1px solid #86efac; border-radius: 8px; padding: 16px; margin-top: 14px; text-align: left; }
        .warning-box .help-box p { color: #166534; font-size: 0.92rem; }
        @media print {
            body { background: white !important; padding: 10px !important; }
            .no-print { display: none !important; }
            .container { max-width: 100%; }
            .header, .writing-panel, .feedback-panel, .sample-panel {
                box-shadow: none !important; break-inside: avoid; page-break-inside: avoid;
            }
            .essay-textarea { border: 1px solid #ccc; }
        }
        @media (max-width: 600px) {
            .topics-grid { grid-template-columns: repeat(2, 1fr); }
            .btn-row { flex-direction: column; }
            .btn { width: 100%; justify-content: center; }
            .header h1 { font-size: 1.5rem; }
        }
    </style>
</head>
<body>
<div class="container" id="app"></div>

<script>
// ‚îÄ‚îÄ‚îÄ COMMON ENGLISH WORDS (top ~600 for validation) ‚îÄ‚îÄ‚îÄ
const ENGLISH_WORDS = new Set([
'the','be','to','of','and','a','in','that','have','i','it','for','not','on','with','he','as','you','do','at','this','but','his','by','from','they','we','her','she','or','an','will','my','one','all','would','there','their','what','so','up','out','if','about','who','get','which','go','me','when','make','can','like','time','no','just','him','know','take','people','into','year','your','good','some','could','them','see','other','than','then','now','look','only','come','its','over','think','also','back','after','use','two','how','our','work','first','well','way','even','new','want','because','any','these','give','day','most','us','great','big','small','very','much','many','more','should','need','still','find','here','thing','tell','help','long','old','man','woman','child','world','life','school','student','hand','place','high','keep','last','city','home','country','food','part','between','change','important','while','start','might','play','run','own','say','ask','read','feel','try','move','same','different','every','off','around','another','before','learn','call','live','three','always','never','both','put','show','must','too','where','right','left','again','through','each','young','kind','little','because','often','really','water','write','money','family','friend','house','book','number','open','close','hard','during','point','today','enough','job','under','social','problem','fact','idea','word','body','health','children','car','information','happen','study','group','sport','buy','team','question','seem','together','leave','few','free','next','example','second','class','talk','yet','side','however','include','late','teach','eat','popular','something','everything','nothing','far','sure','fast','until','experience','already','practice','opinion','spend','near','easy','among','since','once','face','someone','perhaps','morning','online','best','without','town','done','person','bring','age','order','able','especially','pay','real','receive','rest','ready','almost','watch','everyone','phone','true','inside','outside','against','half','several','although','certain','quite','level','rather','answer','sometimes','less','ever'
]);

// ‚îÄ‚îÄ‚îÄ TOPICS ‚îÄ‚îÄ‚îÄ
const TOPICS = [
    { id: 1, emoji: 'üèôÔ∏è', title: 'City Life vs Village Life', prompt: 'living in a city compared to living in a village', keywords: ['city','cities','village','villages','town','urban','rural','country','countryside','live','living','life','apartment','house','traffic','noise','quiet','peaceful','crowded','nature','building'] },
    { id: 2, emoji: 'üìö', title: 'Homework', prompt: 'homework for students', keywords: ['homework','assignment','study','studying','practice','school','teacher','class','learn','learning','lesson','grade','exam','test','student','education','knowledge','subject','review'] },
    { id: 3, emoji: 'üì±', title: 'Social Media', prompt: 'using social media', keywords: ['social','media','instagram','tiktok','snapchat','facebook','twitter','post','posting','online','internet','followers','share','sharing','app','video','photo','platform','digital','connect','communication','message'] },
    { id: 4, emoji: 'üì≤', title: 'Smartphones', prompt: 'using smartphones', keywords: ['smartphone','phone','phones','mobile','app','apps','screen','call','calling','text','texting','device','technology','internet','digital','camera','notification','addicted','addiction'] },
    { id: 5, emoji: 'üõí', title: 'Online Shopping', prompt: 'online shopping', keywords: ['online','shop','shopping','buy','buying','website','delivery','deliver','order','product','products','store','price','cheap','expensive','purchase','customer','internet','amazon','clothes','pay','payment'] },
    { id: 6, emoji: 'üçî', title: 'Fast Food', prompt: 'eating fast food', keywords: ['fast','food','restaurant','eat','eating','meal','cook','cooking','healthy','unhealthy','burger','pizza','chicken','fries','junk','diet','fat','sugar','salt','nutrition','health','weight','obese','obesity','kitchen'] },
    { id: 7, emoji: '‚öΩ', title: 'Team Sports', prompt: 'playing team sports', keywords: ['sport','sports','team','play','playing','football','basketball','volleyball','soccer','exercise','game','match','player','fitness','health','fit','practice','training','coach','win','lose','competition','physical'] },
    { id: 8, emoji: 'üíº', title: 'Part-Time Work', prompt: 'students having part-time jobs', keywords: ['work','working','job','jobs','part-time','money','earn','earning','salary','boss','employee','experience','skill','skills','career','resume','cv','income','hire','responsible','responsibility','office','workplace'] }
];

// ‚îÄ‚îÄ‚îÄ SAMPLE ANSWERS ‚îÄ‚îÄ‚îÄ
const SAMPLES = {
1: `Some people like living in a city, while others prefer living in a village. In this essay, I will discuss the advantages and disadvantages of city life compared to village life, and I will give my personal opinion at the end.

There are several advantages of living in a city. The main advantage is that there are many job opportunities. For example, people can work in offices, hospitals, shops, and restaurants. Another advantage is that cities have better hospitals and schools. This means that people can get good healthcare and education easily. Finally, cities have many shops, restaurants, and cinemas, so life is never boring.

However, there are also several disadvantages of living in a city. The main disadvantage is that city life is very expensive. For example, rent for a small apartment can cost a lot of money every month. Another disadvantage is that cities are very noisy and crowded. This means that people often feel stressed and tired. Finally, the air in cities is not clean because of cars and factories, so it can be bad for your health.

To sum up, I personally believe that both city life and village life have good and bad sides. However, I feel that village life is more peaceful and healthy, even though cities have more opportunities.`,

2: `Some people believe that homework is very useful for students, while others prefer to have free time after school. In this essay, I will discuss the advantages and disadvantages of homework for students, and I will give my personal opinion at the end.

There are several advantages of homework. The main advantage is that it helps students practice what they learn in class. This means that they can remember the lessons better and improve their skills. Another advantage is that homework teaches students to manage their time. For example, they learn to plan when to study and when to rest. Finally, homework helps parents see what their children are learning at school, so they can support them.

However, there are also several disadvantages of homework. The main disadvantage is that students are very tired after school. This means that they do not have energy to do more work at home. Another disadvantage is that too much homework can make students stressed and unhappy. For example, some students stay up very late to finish their homework and cannot sleep well. Finally, some students copy homework from their friends, so they do not learn anything.

In conclusion, I personally feel that homework is important, but teachers should not give too much. A little homework every day is better than a lot of homework at the weekend.`,

3: `Some people believe that social media is a great way to connect with others, while others prefer to spend their time without screens. In this essay, I will discuss the advantages and disadvantages of using social media, and I will give my personal opinion at the end.

There are several advantages of using social media. The main advantage is that it helps people stay in touch with friends and family. For example, you can send messages and share photos with people who live in other countries. Another advantage is that people can learn new things from social media. This means that you can watch educational videos and read useful articles for free. Finally, social media is fun and entertaining, so it helps people relax after a long day.

However, there are also several disadvantages of using social media. The main disadvantage is that many people spend too much time on it. For example, some young people use their phones for five or six hours every day. Another disadvantage is that some people post fake news online. This means that it can be difficult to know what is true and what is false. Finally, cyberbullying is a big problem on social media, so it can make young people feel sad and unsafe.

To conclude, I personally believe that social media is useful, but we should use it carefully. We should limit our time online and not believe everything we read.`,

4: `Some people believe that smartphones make life easier and better, while others prefer a simpler life without too much technology. In this essay, I will discuss the advantages and disadvantages of using smartphones, and I will give my personal opinion at the end.

There are several advantages of using smartphones. The main advantage is that we can call and text our family and friends anytime. This means that we can stay connected, especially in emergencies. Another advantage is that smartphones help us find information very quickly. For example, we can use Google, maps, and translation apps whenever we need them. Finally, there are many useful apps for learning and shopping, so smartphones save us a lot of time.

However, there are also several disadvantages of using smartphones. The main disadvantage is that many people become addicted to their phones. For example, some people check their phones every few minutes, even during meals or classes. Another disadvantage is that smartphones are bad for our health. This means that too much screen time can hurt our eyes and affect our sleep. Finally, smartphones are very expensive, so if you break or lose your phone, it costs a lot of money to replace.

In conclusion, I personally feel that smartphones are very useful tools, but we should not use them too much. We need to put our phones down sometimes and enjoy real life.`,

5: `Some people like buying things online because it is easy and fast, while others prefer going to regular shops to see the products first. In this essay, I will discuss the advantages and disadvantages of online shopping, and I will give my personal opinion at the end.

There are several advantages of online shopping. The main advantage is that it is very convenient. For example, you can shop from your home at any time, even at midnight. Another advantage is that you can compare prices easily. This means that you can find cheaper products and save money. Finally, online shops have more choices than regular shops, so you can buy things from other countries too.

However, there are also several disadvantages of online shopping. The main disadvantage is that sometimes the product looks different from the photo. For example, the colour or size may not be what you expected. Another disadvantage is that you have to wait for delivery. This means that you cannot use the product right away, and sometimes delivery takes a long time. Finally, some websites are not safe, so people can steal your money or personal information.

To sum up, I personally believe that online shopping is great for saving time and money. However, we should be careful and only buy from trusted websites.`,

6: `Some people like eating fast food because it is quick and tasty, while others prefer cooking healthy meals at home. In this essay, I will discuss the advantages and disadvantages of eating fast food, and I will give my personal opinion at the end.

There are several advantages of eating fast food. The main advantage is that it is very quick and easy. This means that you do not have to wait a long time or cook your own food. Another advantage is that fast food is usually cheap. For example, you can buy a full meal for less than the cost of cooking at home. Finally, fast food restaurants are open late at night, so you can eat there at any time.

However, there are also several disadvantages of eating fast food. The main disadvantage is that it is not healthy. For example, a single burger can have a lot of fat, salt, and sugar. Another disadvantage is that eating too much fast food can make people overweight. This means that they may have health problems like heart disease. Finally, fast food creates a lot of rubbish like plastic cups and bags, so it is bad for the environment.

To conclude, I personally feel that fast food is okay sometimes, but we should not eat it every day. It is important to eat healthy food like fruits, vegetables, and home-cooked meals.`,

7: `Some people believe that playing team sports is very important for young people, while others prefer individual activities like reading or drawing. In this essay, I will discuss the advantages and disadvantages of playing team sports, and I will give my personal opinion at the end.

There are several advantages of playing team sports. The main advantage is that they are very good for your health. For example, playing football or basketball helps you exercise regularly and stay fit. Another advantage is that team sports teach you how to work with other people. This means that you learn important skills like teamwork, communication, and respect. Finally, you can make new friends when you join a team, so your social life becomes better.

However, there are also several disadvantages of playing team sports. The main disadvantage is that you can get injured while playing. For example, broken bones and muscle injuries are common in contact sports like football. Another disadvantage is that team sports take a lot of time. This means that you have to go to practice and games regularly, and this can be difficult if you have a lot of homework. Finally, some players feel very stressed when they lose a game, so it can affect their mood and confidence.

In conclusion, I personally believe that team sports are very good for young people. The advantages are more than the disadvantages, and I feel that every student should try at least one team sport.`,

8: `Some people believe that part-time jobs are a great experience for students, while others prefer students to focus only on their studies. In this essay, I will discuss the advantages and disadvantages of students having part-time jobs, and I will give my personal opinion at the end.

There are several advantages of part-time work for students. The main advantage is that students can earn their own money. This means that they can buy things without asking their parents and learn the value of money. Another advantage is that working teaches students important skills. For example, they learn communication, responsibility, and time management. Finally, work experience looks good on a CV, so it can help students find a better job after they finish their studies.

However, there are also several disadvantages of part-time work for students. The main disadvantage is that working can take time away from studying. This means that students may not have enough time to do their homework or prepare for exams. Another disadvantage is that some students feel very tired after work. For example, they may fall asleep in class or not concentrate on their lessons. Finally, some jobs are boring and do not pay well, so students may feel unhappy and frustrated.

To sum up, I personally feel that a part-time job can be good for students, but only if it does not affect their studies. Students should choose a job with flexible hours and not work too many hours per week.`
};


// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// QUALITY GATE ‚Äî Check if text is a real essay
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function qualityCheck(text, topic) {
    const issues = [];
    const lower = text.toLowerCase().trim();
    const words = lower.split(/\s+/).filter(w => w.length > 0);
    const wc = words.length;

    // 1. Check for gibberish / random characters
    const alphaOnly = text.replace(/[^a-zA-Z\s]/g, '').trim();
    const alphaRatio = alphaOnly.length / Math.max(1, text.trim().length);
    if (alphaRatio < 0.5) {
        issues.push({ type: 'gibberish', msg: 'Your text contains too many random characters or symbols. Please write in English using letters and words.' });
    }

    // 2. Check if words are actual English words
    const cleanWords = words.map(w => w.replace(/[^a-z'-]/g, '')).filter(w => w.length > 1);
    const englishCount = cleanWords.filter(w => ENGLISH_WORDS.has(w)).length;
    const englishRatio = englishCount / Math.max(1, cleanWords.length);
    if (englishRatio < 0.3 && wc > 5) {
        issues.push({ type: 'not_english', msg: 'Most of these words are not recognized as English. Please write your essay in English.' });
    } else if (englishRatio < 0.45 && wc > 10) {
        issues.push({ type: 'low_english', msg: 'Many words in your text are not recognized English words. Check for typing errors and spelling mistakes.' });
    }

    // 3. Check for repeated characters / keyboard mashing (e.g., "asdfjkl", "aaaaaaa")
    const longRepeats = text.match(/(.)\1{4,}/g);
    if (longRepeats && longRepeats.length > 0) {
        issues.push({ type: 'repeated_chars', msg: 'Your text contains repeated characters (e.g., "' + longRepeats[0].substring(0,8) + '..."). Please write real sentences.' });
    }
    // Check for keyboard patterns
    const kbPatterns = ['asdf','qwer','zxcv','jkl;','uiop','fghj','sdfg','dfgh','ghjk','hjkl','xcvb','cvbn','vbnm','tyui','yuio','1234','abcd','aaaa','bbbb'];
    const hasKbPattern = kbPatterns.some(p => lower.includes(p));
    if (hasKbPattern && englishRatio < 0.5) {
        issues.push({ type: 'keyboard_mash', msg: 'It looks like you typed random keys on the keyboard. Please write a real essay about the topic.' });
    }

    // 4. Check for real sentences (must have at least some sentences with 3+ words)
    const sentences = text.split(/[.!?]+/).filter(s => s.trim().length > 0);
    const realSentences = sentences.filter(s => s.trim().split(/\s+/).length >= 3);
    if (realSentences.length < 2 && wc > 10) {
        issues.push({ type: 'no_sentences', msg: 'Your text does not contain clear sentences. Write complete sentences with a subject and a verb, ending with a full stop.' });
    }

    // 5. Same word/phrase repeated many times (copy-paste spam)
    const wordFreq = {};
    cleanWords.forEach(w => { if (w.length > 2) wordFreq[w] = (wordFreq[w] || 0) + 1; });
    const maxFreq = Math.max(0, ...Object.values(wordFreq));
    const topWord = Object.entries(wordFreq).find(([w,c]) => c === maxFreq);
    if (maxFreq > wc * 0.25 && wc > 10 && topWord && !ENGLISH_WORDS.has(topWord[0])) {
        issues.push({ type: 'spam_repeat', msg: 'The word "' + topWord[0] + '" is repeated too many times (' + maxFreq + ' times). This does not look like a real essay.' });
    }
    // Check if just same sentence copied
    if (sentences.length >= 3) {
        const uniqueSentences = new Set(sentences.map(s => s.trim().toLowerCase()));
        if (uniqueSentences.size <= Math.ceil(sentences.length * 0.3)) {
            issues.push({ type: 'copied_sentences', msg: 'Your essay repeats the same sentences multiple times. Each sentence should be different.' });
        }
    }

    // 6. Topic relevance ‚Äî check against topic keywords
    const topicHits = topic.keywords.filter(k => lower.includes(k)).length;
    const essayWords = ['advantage','disadvantage','advantages','disadvantages','benefit','problem','opinion','think','believe','conclusion','however','because','first','second'];
    const essayHits = essayWords.filter(w => lower.includes(w)).length;

    if (topicHits === 0 && essayHits === 0 && wc > 15 && englishRatio > 0.3) {
        issues.push({ type: 'off_topic', msg: 'Your text does not seem to be about "' + topic.title + '" and does not look like an advantage/disadvantage essay. Make sure you write about the correct topic.' });
    } else if (topicHits === 0 && wc > 20 && englishRatio > 0.3) {
        issues.push({ type: 'maybe_off_topic', msg: 'Your essay does not mention anything about "' + topic.title + '". Make sure you are writing about the correct topic and use words related to it.' });
    }

    // 7. Too short to be an essay
    if (wc < 20) {
        issues.push({ type: 'too_short', msg: 'You only wrote ' + wc + ' words. An essay needs at least 100-150 words. Please write more.' });
    }

    // Determine severity
    const blockers = issues.filter(i => ['gibberish','not_english','keyboard_mash','repeated_chars','spam_repeat','copied_sentences'].includes(i.type));
    const warnings = issues.filter(i => !blockers.includes(i));

    return {
        pass: blockers.length === 0,
        issues: issues,
        blockers: blockers,
        warnings: warnings,
        stats: { wc, englishRatio: Math.round(englishRatio * 100), topicHits, essayHits, realSentences: realSentences.length }
    };
}


// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// DEEP ESSAY ANALYZER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function analyzeEssay(essay, topic) {
    const text = essay.trim();
    const lower = text.toLowerCase();
    const words = text.split(/\s+/).filter(w => w.length > 0);
    const wc = words.length;
    const sentences = text.split(/(?<=[.!?])\s+/).filter(s => s.trim().length > 2);
    const paragraphs = text.split(/\n\s*\n/).filter(p => p.trim().length > 0);
    const pCount = paragraphs.length;
    const avgSentLen = sentences.length > 0 ? Math.round(wc / sentences.length) : 0;

    // ‚îÄ‚îÄ‚îÄ GRAMMAR ‚îÄ‚îÄ‚îÄ
    const grammarErrors = [];
    sentences.forEach((s) => {
        const t = s.trim();
        if (!t) return;
        if (/^[a-z]/.test(t)) {
            grammarErrors.push({ original: t.substring(0, Math.min(40, t.length)) + (t.length > 40 ? '...' : ''), issue: 'This sentence should start with a capital letter.', fix: t.charAt(0).toUpperCase() + t.substring(1, Math.min(40, t.length)) + (t.length > 40 ? '...' : '') });
        }
        if (/\bi\b(?!')/.test(t)) {
            const m = t.match(/\b(i\s+\w+)/);
            if (m) grammarErrors.push({ original: '"' + m[1] + '"', issue: 'The pronoun "I" must always be a capital letter.', fix: '"' + m[1].replace(/^i/, 'I') + '"' });
        }
        if (/\s[.,!?;:]/.test(t)) {
            const m = t.match(/(\w+)\s([.,!?;:])/);
            if (m) grammarErrors.push({ original: '"' + m[0] + '"', issue: 'Do not put a space before ' + m[2], fix: '"' + m[1] + m[2] + '"' });
        }
        if (/[.,!?;:][A-Za-z]/.test(t)) {
            const m = t.match(/([.,!?;:])([A-Za-z]\w*)/);
            if (m) grammarErrors.push({ original: '"' + m[0] + '"', issue: 'Add a space after ' + m[1], fix: '"' + m[1] + ' ' + m[2] + '"' });
        }
        if (/\bpeoples\b/i.test(t)) grammarErrors.push({ original: '"peoples"', issue: '"People" is already plural. Do not add "s".', fix: '"people"' });
        if (/\binformations\b/i.test(t)) grammarErrors.push({ original: '"informations"', issue: '"Information" is uncountable. Do not add "s".', fix: '"information"' });
        if (/\badvices\b/i.test(t)) grammarErrors.push({ original: '"advices"', issue: '"Advice" is uncountable. Do not add "s".', fix: '"advice"' });
        if (/\bhomeworks\b/i.test(t)) grammarErrors.push({ original: '"homeworks"', issue: '"Homework" is uncountable. Do not add "s".', fix: '"homework"' });
        if (/\bchildrens\b/i.test(t)) grammarErrors.push({ original: '"childrens"', issue: '"Children" is already plural.', fix: '"children"' });
        const dc = t.match(/\bmore\s+(better|worse|easier|harder|bigger|smaller|faster|slower|cheaper|nicer)\b/i);
        if (dc) grammarErrors.push({ original: '"more ' + dc[1] + '"', issue: 'Do not use "more" with comparative words ending in "-er".', fix: '"' + dc[1] + '"' });
        const ds = t.match(/\bmost\s+(cheapest|biggest|smallest|fastest|slowest|easiest|hardest|nicest|best|worst)\b/i);
        if (ds) grammarErrors.push({ original: '"most ' + ds[1] + '"', issue: 'Do not use "most" with superlative words.', fix: '"' + ds[1] + '"' });
        if (/\balot\b/i.test(t)) grammarErrors.push({ original: '"alot"', issue: 'This should be two words.', fix: '"a lot"' });
        const spell = [
            [/\b(becouse|becuase|beacuse|becasue)\b/i, 'because'],
            [/\bwich\b/i, 'which'], [/\bthier\b/i, 'their'], [/\brecieve\b/i, 'receive'],
            [/\b(diffrent|differnt)\b/i, 'different'], [/\bintresting\b/i, 'interesting'],
            [/\b(definately|definetly|defintely)\b/i, 'definitely'], [/\bfreind\b/i, 'friend'],
            [/\btomorow\b/i, 'tomorrow'], [/\btogehter\b/i, 'together'], [/\bbeautifull\b/i, 'beautiful'],
            [/\benviroment\b/i, 'environment'], [/\bgoverment\b/i, 'government'],
            [/\bexampel\b/i, 'example'], [/\bbelive\b/i, 'believe'], [/\boppinion\b/i, 'opinion'],
            [/\baddvantage\b/i, 'advantage'], [/\bdisaddvantage\b/i, 'disadvantage'],
            [/\bpoeple\b/i, 'people'], [/\bspecaily\b/i, 'especially'], [/\bimportent\b/i, 'important'],
            [/\bexpirience\b/i, 'experience'], [/\bcomfortable\b/i, null], [/\bwensday\b/i, 'Wednesday'],
            [/\bconclusion\b/i, null], [/\bprobaly\b/i, 'probably'], [/\bexcersise\b/i, 'exercise'],
        ];
        spell.forEach(([rx, correct]) => {
            if (correct && rx.test(t)) {
                const m = t.match(rx);
                grammarErrors.push({ original: '"' + m[0] + '"', issue: 'Spelling mistake.', fix: '"' + correct + '"' });
            }
        });
        const sv1 = t.match(/\b(he|she|it|everyone|everybody|someone|nobody|everything)\s+have\b/i);
        if (sv1) grammarErrors.push({ original: '"' + sv1[0] + '"', issue: 'Use "has" with ' + sv1[1] + '.', fix: '"' + sv1[1] + ' has"' });
        const sv2 = t.match(/\b(they|we|people|students|children)\s+has\b/i);
        if (sv2) grammarErrors.push({ original: '"' + sv2[0] + '"', issue: 'Use "have" with ' + sv2[1] + '.', fix: '"' + sv2[1] + ' have"' });
        const sv3 = t.match(/\b(he|she|it)\s+don't\b/i);
        if (sv3) grammarErrors.push({ original: '"' + sv3[0] + '"', issue: "Use \"doesn't\" with " + sv3[1] + '.', fix: '"' + sv3[1] + " doesn't\"" });
        if (/\bthere\s+is\s+(many|several|a lot of)\b/i.test(t)) {
            const m3 = t.match(/\b(there\s+is\s+(many|several|a lot of)\s+\w+)/i);
            if (m3) grammarErrors.push({ original: '"' + m3[1].substring(0, 35) + '"', issue: 'Use "there are" with plural/many.', fix: '"There are ' + m3[1].replace(/there\s+is\s+/i, '').substring(0, 30) + '"' });
        }
    });
    if (text.length > 0 && !/[.!?]\s*$/.test(text)) {
        grammarErrors.push({ original: '(end of essay)', issue: 'End with a full stop, question mark, or exclamation mark.', fix: 'Add punctuation.' });
    }
    // Deduplicate
    const seen = new Set(); const uniqueErrors = [];
    grammarErrors.forEach(e => { const k = e.original + e.issue; if (!seen.has(k)) { seen.add(k); uniqueErrors.push(e); } });
    const topErrors = uniqueErrors.slice(0, 8);
    let grammarScore = 10 - Math.min(6, uniqueErrors.length);
    if (avgSentLen > 22) grammarScore -= 1;
    grammarScore = Math.max(1, Math.min(10, grammarScore));

    // ‚îÄ‚îÄ‚îÄ VOCABULARY ‚îÄ‚îÄ‚îÄ
    const linkCats = {
        'sequencing': { words: ['first','firstly','second','secondly','third','thirdly','finally','next','then','after that','lastly'], found: [] },
        'contrast': { words: ['however','but','on the other hand','although','nevertheless','despite','in contrast','while','whereas','yet'], found: [] },
        'addition': { words: ['also','moreover','furthermore','in addition','besides','as well'], found: [] },
        'cause/reason': { words: ['because','so','therefore','as a result','due to','since','for this reason'], found: [] },
        'example': { words: ['for example','for instance','such as'], found: [] },
        'conclusion': { words: ['in conclusion','to sum up','in my opinion','i think','i believe','overall','to conclude','all in all'], found: [] }
    };
    for (const c in linkCats) linkCats[c].found = linkCats[c].words.filter(w => lower.includes(w));
    const allLink = Object.values(linkCats).flatMap(c => c.found);
    const missingCats = Object.entries(linkCats).filter(([,v]) => v.found.length === 0).map(([k]) => k);

    const ignore = new Set(['the','a','an','is','are','was','were','be','been','am','i','you','he','she','it','we','they','my','your','his','her','its','our','their','and','but','or','so','if','in','on','at','to','for','of','with','from','by','that','this','these','those','not','no','do','does','did','can','will','have','has','had','very','also','too','many','much','more','some','all','about','there','which','what','when','how','who','would','should','could','just','than','them','other','into','most','only','after','before','between','over','then','each','make','way','may','such','being','both','through','get','got']);
    const freq = {};
    words.forEach(w => { const c = w.toLowerCase().replace(/[^a-z'-]/g, ''); if (c.length > 2 && !ignore.has(c)) freq[c] = (freq[c] || 0) + 1; });
    const overused = Object.entries(freq).filter(([,c]) => c >= 4).sort((a, b) => b[1] - a[1]).slice(0, 4);

    const vocabSugg = [];
    const sMap = [
        { find: /\bgood\b/i, used: 'good', suggest: 'useful, helpful, positive, beneficial' },
        { find: /\bbad\b/i, used: 'bad', suggest: 'harmful, negative, unhealthy, dangerous' },
        { find: /\bbig\b/i, used: 'big', suggest: 'large, major, significant, important' },
        { find: /\bvery good\b/i, used: 'very good', suggest: 'excellent, great, wonderful' },
        { find: /\bvery bad\b/i, used: 'very bad', suggest: 'terrible, awful, harmful' },
        { find: /\bvery big\b/i, used: 'very big', suggest: 'huge, enormous, massive' },
        { find: /\bvery important\b/i, used: 'very important', suggest: 'essential, crucial, vital' },
        { find: /\ba lot of\b/i, used: 'a lot of', suggest: 'many, several, numerous / much' },
        { find: /\bthing\b/i, used: 'thing', suggest: 'advantage, benefit, aspect, factor, issue' },
        { find: /\bnice\b/i, used: 'nice', suggest: 'pleasant, enjoyable, wonderful' },
        { find: /\bhappy\b/i, used: 'happy', suggest: 'pleased, satisfied, delighted' },
        { find: /\bsad\b/i, used: 'sad', suggest: 'upset, disappointed, unhappy' },
    ];
    sMap.forEach(s => { if (s.find.test(lower)) vocabSugg.push({ used: s.used, suggest: s.suggest }); });

    const uniq = new Set(words.map(w => w.toLowerCase().replace(/[^a-z]/g, '')).filter(w => w.length > 2));
    let vocabScore = 5;
    if (allLink.length >= 6) vocabScore += 3;
    else if (allLink.length >= 4) vocabScore += 2;
    else if (allLink.length >= 2) vocabScore += 1;
    if (uniq.size / Math.max(1, wc) > 0.55) vocabScore += 1;
    if (vocabSugg.length <= 1) vocabScore += 1;
    vocabScore = Math.max(1, Math.min(10, vocabScore));

    // ‚îÄ‚îÄ‚îÄ TASK ACHIEVEMENT ‚îÄ‚îÄ‚îÄ
    const taskChecks = [];
    const hasIntro = pCount >= 1 && (/in this essay/i.test(paragraphs[0]) || /i will (talk|discuss|write)/i.test(paragraphs[0]) || /advantages and disadvantages/i.test(paragraphs[0]));
    taskChecks.push({ pass: hasIntro, text: hasIntro ? '‚úÖ Introduction paragraph found' : '‚ùå Write a clear introduction. Say: "In this essay, I will discuss the advantages and disadvantages of ' + topic.prompt + ', and I will give my personal opinion at the end."' });

    const hasContrast = /some people (believe|think|like|prefer|say|feel).*while others/i.test(lower) || /while others (prefer|believe|think|like|say|feel)/i.test(lower);
    taskChecks.push({ pass: hasContrast, text: hasContrast ? '‚úÖ Good opening ‚Äî you showed two different views' : '‚ùå Start your introduction with: "Some people believe... while others prefer..." to show two different opinions.' });

    const advW = ['advantage','advantages','benefit','benefits','positive'];
    const advPara = paragraphs.find(p => advW.some(w => p.toLowerCase().includes(w)));
    const hasAdvStructure = /the main advantage is that/i.test(lower) || /another advantage is that/i.test(lower) || /there are several advantages/i.test(lower);
    taskChecks.push({ pass: !!advPara && hasAdvStructure, text: (advPara && hasAdvStructure) ? '‚úÖ Advantages section with good structure found' : (!advPara ? '‚ùå Add an advantages paragraph. Start with: "There are several advantages of ' + topic.prompt + '. The main advantage is that..."' : '‚ö†Ô∏è You mentioned advantages, but use this structure: "The main advantage is that... Another advantage is that... Finally, ..."') });

    const hasExplanations = (lower.match(/this means that/gi) || []).length + (lower.match(/for example/gi) || []).length;
    taskChecks.push({ pass: hasExplanations >= 2, text: hasExplanations >= 2 ? '‚úÖ Good ‚Äî you supported your points with explanations and examples (' + hasExplanations + ' found)' : '‚ùå After each advantage/disadvantage, add an explanation or example using "This means that..." or "For example, ..." (' + hasExplanations + ' found, need at least 2)' });

    const disW = ['disadvantage','disadvantages','problem','problems','negative'];
    const disPara = paragraphs.find(p => disW.some(w => p.toLowerCase().includes(w)));
    const hasDisStructure = /the main disadvantage is that/i.test(lower) || /another disadvantage is that/i.test(lower) || /there are (also )?several disadvantages/i.test(lower);
    taskChecks.push({ pass: !!disPara && hasDisStructure, text: (disPara && hasDisStructure) ? '‚úÖ Disadvantages section with good structure found' : (!disPara ? '‚ùå Add a disadvantages paragraph. Start with: "However, there are also several disadvantages. The main disadvantage is that..."' : '‚ö†Ô∏è You mentioned disadvantages, but use this structure: "The main disadvantage is that... Another disadvantage is that... Finally, ..."') });

    const opW = ['in conclusion','to conclude','to sum up'];
    const persW = ['i personally believe','i personally feel','personally i believe','personally i feel','i personally think'];
    const lastP = paragraphs.length > 0 ? paragraphs[paragraphs.length - 1].toLowerCase() : '';
    const hasConcl = opW.some(p => lastP.includes(p));
    const hasPersonal = persW.some(p => lower.includes(p)) || (/i (believe|feel|think)/i.test(lastP) && hasConcl);
    taskChecks.push({ pass: hasConcl && hasPersonal, text: (hasConcl && hasPersonal) ? '‚úÖ Strong conclusion with your personal opinion' : (!hasConcl ? '‚ùå Start your conclusion with: "In conclusion, / To conclude, / To sum up," followed by your opinion.' : '‚ö†Ô∏è Good conclusion starter, but add your personal opinion: "I personally believe/feel that..."') });

    taskChecks.push({ pass: pCount >= 4, text: pCount >= 4 ? '‚úÖ Good structure ‚Äî ' + pCount + ' paragraphs' : '‚ùå You have ' + pCount + ' paragraph(s). Write 4 paragraphs. Press Enter twice to start a new one.' });

    const wcOk = wc >= 120 && wc <= 230;
    taskChecks.push({ pass: wcOk, text: wcOk ? '‚úÖ Good length ‚Äî ' + wc + ' words' : (wc < 120 ? '‚ùå Only ' + wc + ' words ‚Äî write at least 150. Add examples and details.' : '‚ö†Ô∏è ' + wc + ' words ‚Äî try to stay under 200.') });

    const topicHits = topic.keywords.filter(k => lower.includes(k)).length;
    taskChecks.push({ pass: topicHits >= 2, text: topicHits >= 2 ? '‚úÖ Essay is about ' + topic.title : '‚ö†Ô∏è Your essay doesn\'t clearly mention "' + topic.title + '". Use words related to this topic.' });

    const passCount = taskChecks.filter(c => c.pass).length;
    let taskScore = Math.max(1, Math.min(10, Math.round((passCount / taskChecks.length) * 10)));

    // ‚îÄ‚îÄ‚îÄ TIPS ‚îÄ‚îÄ‚îÄ
    const tips = [];
    if (pCount < 4) tips.push('Divide your essay into 4 paragraphs. Press Enter twice between each one.');
    if (!hasIntro) tips.push('Start with: "In this essay, I will discuss the advantages and disadvantages of ' + topic.prompt + '."');
    if (!advPara) tips.push('In paragraph 2, write: "There are some advantages of ' + topic.prompt + '. First, ... Second, ... Also, ..."');
    if (!disPara) tips.push('In paragraph 3, write: "However, there are also disadvantages. First, ... Also, ..."');
    if (!hasConcl) tips.push('End with: "In conclusion, I think..." and give your opinion.');
    if (missingCats.includes('contrast') && tips.length < 6) tips.push('Use contrast words like "However" or "On the other hand" between advantages and disadvantages.');
    if (missingCats.includes('example') && tips.length < 6) tips.push('Add examples: "For example, ..." to support your points.');
    if (missingCats.includes('sequencing') && tips.length < 6) tips.push('Organize ideas with "First", "Second", "Finally".');
    if (overused.length > 0 && tips.length < 6) tips.push('You used "' + overused[0][0] + '" ' + overused[0][1] + ' times. Try synonyms to avoid repetition.');
    if (wc < 100 && tips.length < 6) tips.push('Write more! After each point, ask yourself "Why?" and "For example?"');
    if (avgSentLen > 20 && tips.length < 6) tips.push('Your sentences average ' + avgSentLen + ' words. Keep most under 15 words.');
    if (tips.length === 0) tips.push('Excellent work! Try another topic to practice more. üí™');
    if (tips.length < 2) tips.push('Read the sample answer to discover useful phrases you can use in your own essays.');

    return {
        grammar: { score: grammarScore, errors: topErrors },
        vocabulary: { score: vocabScore, linking: linkCats, allLinking: allLink, missing: missingCats, suggestions: vocabSugg.slice(0, 4), overused, uniqueCount: uniq.size },
        task: { score: taskScore, checks: taskChecks },
        tips: tips.slice(0, 6),
        stats: { wc, sentences: sentences.length, paragraphs: pCount, avgSentLen }
    };
}


// ‚îÄ‚îÄ‚îÄ STATE & RENDERING ‚îÄ‚îÄ‚îÄ
let state = { screen: 'topics', selectedTopic: null, essay: '', feedback: null, rejected: null, showSample: false };

function countWords(t) { return t.trim() ? t.trim().split(/\s+/).length : 0; }
function esc(s) { const d = document.createElement('div'); d.textContent = s; return d.innerHTML; }

function render() {
    const app = document.getElementById('app');
    if (state.screen === 'topics') renderTopics(app);
    else renderWriting(app);
}

function renderTopics(app) {
    app.innerHTML = `
        <div class="header"><h1>‚úçÔ∏è Essay Builder</h1><p>Learn to write advantage & disadvantage essays</p><span class="badge">A2+ Level</span></div>
        <p style="color:white;text-align:center;margin-bottom:18px;font-size:1.05rem;">Choose a topic to start writing:</p>
        <div class="topics-grid">${TOPICS.map(t => `
            <div class="topic-card" onclick="selectTopic(${t.id})"><span class="emoji">${t.emoji}</span><span class="title">${t.title}</span></div>`).join('')}
        </div>`;
}

function selectTopic(id) {
    state.selectedTopic = TOPICS.find(t => t.id === id);
    state.essay = ''; state.feedback = null; state.rejected = null; state.showSample = false;
    state.screen = 'writing'; render();
}
function goBack() { state.screen = 'topics'; state.feedback = null; state.rejected = null; state.showSample = false; render(); }

function renderWriting(app) {
    const t = state.selectedTopic;
    const wc = countWords(state.essay);

    let html = `
        <div class="back-link no-print" onclick="goBack()">‚Üê Back to Topics</div>
        <div class="header"><h1>‚úçÔ∏è Essay Builder</h1><p>Learn to write advantage & disadvantage essays</p><span class="badge">A2+ Level</span></div>
        <div class="writing-panel">
            <h2>${t.emoji} Write Your Essay</h2>
            <div class="topic-label">Topic: ${t.title}</div>
            <div class="instructions">
                <strong>üìù Instructions:</strong><br>
                Write an essay about the <strong>advantages and disadvantages of ${t.prompt}</strong>.<br><br>
                Your essay should have <strong>4 paragraphs</strong>:<br>
                1Ô∏è‚É£ <strong>Introduction</strong> ‚Äì "Some people believe... while others prefer..." + "and I will give my personal opinion at the end."<br>
                2Ô∏è‚É£ <strong>Advantages</strong> ‚Äì "There are several advantages of..." Use: "The main advantage is that..." + "This means that..." or "For example, ..." / "Another advantage is that..." / "Finally, ..."<br>
                3Ô∏è‚É£ <strong>Disadvantages</strong> ‚Äì "There are also several disadvantages of..." Use the same pattern with examples or explanations.<br>
                4Ô∏è‚É£ <strong>Conclusion</strong> ‚Äì "In conclusion / To conclude / To sum up, I personally believe/feel that..."<br><br>
                ‚úÖ Try to write <strong>150‚Äì200 words</strong>. Add examples or explanations for each point!
            </div>
            <textarea class="essay-textarea" id="essayInput" placeholder="Write your essay here...&#10;&#10;Press Enter twice to start a new paragraph..." oninput="updateEssay(this.value)">${esc(state.essay)}</textarea>
            <div class="word-count ${wc < 100 ? 'low' : 'good'}" id="wordCount">Words: ${wc} / 200</div>
            <div class="btn-row no-print">
                <button class="btn btn-primary" onclick="getFeedback()" id="btnFeedback" ${wc < 15 ? 'disabled' : ''}>üìù Get Feedback</button>
                <button class="btn btn-green" onclick="toggleSample()">üìÑ ${state.showSample ? 'Hide' : 'Show'} Sample Answer</button>
                <button class="btn btn-gray" onclick="clearEssay()">üóëÔ∏è Clear</button>
            </div>
        </div>`;

    // ‚îÄ‚îÄ‚îÄ REJECTION WARNING ‚îÄ‚îÄ‚îÄ
    if (state.rejected) {
        const r = state.rejected;
        html += `
        <div class="warning-box" id="rejectPanel">
            <div class="icon">üö´</div>
            <h2>This does not look like an essay</h2>
            <p>I checked your text and found some problems. Please fix them and try again.</p>
            <ul class="issues">${r.issues.map(i => '<li>' + esc(i.msg) + '</li>').join('')}</ul>
            <div class="help-box">
                <p><strong>üí° How to write your essay:</strong></p>
                <p>‚Ä¢ <strong>Introduction:</strong> "Some people believe... while others prefer... In this essay, I will discuss... and I will give my personal opinion at the end."</p>
                <p>‚Ä¢ <strong>Advantages:</strong> "There are several advantages of... The main advantage is that..." + "This means that..." or "For example, ..."</p>
                <p>‚Ä¢ <strong>Disadvantages:</strong> "However, there are also several disadvantages... The main disadvantage is that..." + "This means that..." or "For example, ..."</p>
                <p>‚Ä¢ <strong>Conclusion:</strong> "In conclusion, I personally believe/feel that..."</p>
                <p>‚Ä¢ Write in <strong>English</strong>, at least <strong>100 words</strong>, about <strong>${esc(t.title)}</strong>.</p>
                <p>‚Ä¢ Click <strong>"Show Sample Answer"</strong> to see an example! üëÜ</p>
            </div>
        </div>`;
    }

    // ‚îÄ‚îÄ‚îÄ FEEDBACK ‚îÄ‚îÄ‚îÄ
    if (state.feedback) {
        const f = state.feedback;
        const sc = s => s >= 7 ? 'green' : s >= 5 ? 'yellow' : 'red';

        let gramHtml = '';
        if (f.grammar.errors.length === 0) {
            gramHtml = '<p>‚ú® No grammar errors found! Your writing is clear and correct.</p>';
        } else {
            gramHtml = '<p style="margin-bottom:10px;">I found <strong>' + f.grammar.errors.length + ' issue(s)</strong> in your essay:</p>';
            f.grammar.errors.forEach(e => {
                gramHtml += `<div class="error-highlight"><span class="original">${esc(e.original)}</span> ‚Üí <span class="correction">${esc(e.fix)}</span><br><span class="explain">${esc(e.issue)}</span></div>`;
            });
        }
        gramHtml += `<p style="margin-top:12px;color:#6b7280;font-size:0.88rem;">Average sentence length: ${f.stats.avgSentLen} words (aim for 8‚Äì15)</p>`;

        let vocHtml = '<p style="margin-bottom:10px;"><strong>Linking words you used:</strong> ';
        if (f.vocabulary.allLinking.length > 0) {
            vocHtml += f.vocabulary.allLinking.map(w => '<span style="background:#dbeafe;padding:2px 8px;border-radius:4px;margin:2px;display:inline-block;font-size:0.88rem;">' + esc(w) + '</span>').join(' ');
            vocHtml += ' (' + f.vocabulary.allLinking.length + ' found)</p>';
        } else {
            vocHtml += '<span style="color:#dc2626;">None found!</span></p>';
        }
        if (f.vocabulary.missing.length > 0 && f.vocabulary.missing.length < 6) {
            const sug = { 'sequencing': 'First, Second, Finally', 'contrast': 'However, On the other hand', 'addition': 'Also, Moreover, In addition', 'cause/reason': 'Because, So, Therefore', 'example': 'For example, Such as', 'conclusion': 'In conclusion, In my opinion' };
            vocHtml += '<p style="margin-top:8px;">üìå <strong>Try adding:</strong> ' + f.vocabulary.missing.map(m => '<em>' + m + '</em> (' + (sug[m] || '') + ')').join(', ') + '</p>';
        }
        if (f.vocabulary.suggestions.length > 0) {
            vocHtml += '<p style="margin-top:12px;"><strong>Try stronger vocabulary:</strong></p>';
            f.vocabulary.suggestions.forEach(s => { vocHtml += `<div class="vocab-suggestion"><span class="used">Instead of "${esc(s.used)}"</span> ‚Üí <span class="better">${esc(s.suggest)}</span></div>`; });
        }
        if (f.vocabulary.overused.length > 0) {
            vocHtml += '<p style="margin-top:10px;">‚ö†Ô∏è <strong>Overused:</strong> ' + f.vocabulary.overused.map(([w,c]) => '"' + w + '" (' + c + 'x)').join(', ') + ' ‚Äî try synonyms.</p>';
        }
        vocHtml += `<p style="margin-top:8px;color:#6b7280;font-size:0.88rem;">You used ${f.vocabulary.uniqueCount} unique words out of ${f.stats.wc} total.</p>`;

        let taskHtml = '';
        f.task.checks.forEach(c => { taskHtml += `<div class="task-check ${c.pass ? 'pass' : 'fail'}">${c.text}</div>`; });

        let tipsHtml = f.tips.map((tip, i) => '<p style="margin-bottom:8px;">' + (i + 1) + '. ' + esc(tip) + '</p>').join('');

        const total = f.grammar.score + f.vocabulary.score + f.task.score;

        html += `
        <div class="feedback-panel" id="feedbackPanel">
            <h2>üìù Your Personalized Feedback</h2>
            <p style="color:#6b7280;margin-bottom:4px;">üìä ${f.stats.wc} words ¬∑ ${f.stats.sentences} sentences ¬∑ ${f.stats.paragraphs} paragraph(s)</p>
            <p style="color:#6b7280;margin-bottom:18px;">Overall: <strong>${total}/30</strong> ${total >= 24 ? '‚≠ê Excellent!' : total >= 18 ? 'üëç Good work!' : total >= 12 ? 'üìù Keep improving!' : 'üí™ You can do better!'}</p>
            <div class="feedback-section task-section">
                <h3>‚úÖ Task Achievement ‚Äî ${f.task.score}/10</h3>
                <div class="score-bar"><div class="score-fill ${sc(f.task.score)}" style="width:${f.task.score * 10}%"></div></div>
                <div style="margin-top:12px;">${taskHtml}</div>
            </div>
            <div class="feedback-section grammar-section">
                <h3>üìñ Grammar & Spelling ‚Äî ${f.grammar.score}/10</h3>
                <div class="score-bar"><div class="score-fill ${sc(f.grammar.score)}" style="width:${f.grammar.score * 10}%"></div></div>
                <div style="margin-top:12px;">${gramHtml}</div>
            </div>
            <div class="feedback-section vocab-section">
                <h3>üìò Vocabulary & Linking Words ‚Äî ${f.vocabulary.score}/10</h3>
                <div class="score-bar"><div class="score-fill ${sc(f.vocabulary.score)}" style="width:${f.vocabulary.score * 10}%"></div></div>
                <div style="margin-top:12px;">${vocHtml}</div>
            </div>
            <div class="feedback-section tips-section">
                <h3>üí° Your Next Steps</h3>
                ${tipsHtml}
            </div>
            <div class="btn-row no-print">
                <button class="btn btn-print" onclick="printPage()">üñ®Ô∏è Print Essay & Feedback</button>
            </div>
        </div>`;
    }

    // ‚îÄ‚îÄ‚îÄ SAMPLE ‚îÄ‚îÄ‚îÄ
    if (state.showSample && SAMPLES[t.id]) {
        html += `
        <div class="sample-panel" id="samplePanel">
            <h2>üìÑ Sample Answer ‚Äî ${t.title}</h2>
            <div class="sample-essay">${esc(SAMPLES[t.id])}</div>
            <div class="btn-row no-print"><button class="btn btn-print" onclick="printPage()">üñ®Ô∏è Print Sample Answer</button></div>
        </div>`;
    }

    app.innerHTML = html;
}

function updateEssay(val) {
    state.essay = val;
    const wc = countWords(val);
    const el = document.getElementById('wordCount');
    if (el) { el.textContent = 'Words: ' + wc + ' / 200'; el.className = 'word-count ' + (wc < 100 ? 'low' : 'good'); }
    const btn = document.getElementById('btnFeedback');
    if (btn) btn.disabled = wc < 15;
    // Clear previous feedback when text changes significantly
    if (state.feedback || state.rejected) { state.feedback = null; state.rejected = null; }
}
function clearEssay() { state.essay = ''; state.feedback = null; state.rejected = null; state.showSample = false; render(); }

function getFeedback() {
    if (countWords(state.essay) < 15) return;

    // QUALITY GATE first
    const qc = qualityCheck(state.essay, state.selectedTopic);
    if (!qc.pass) {
        state.rejected = qc;
        state.feedback = null;
        render();
        setTimeout(() => { const el = document.getElementById('rejectPanel'); if (el) el.scrollIntoView({ behavior: 'smooth' }); }, 100);
        return;
    }

    // If warnings but still passes, include them but proceed
    state.rejected = null;
    state.feedback = analyzeEssay(state.essay, state.selectedTopic);

    // Add quality warnings to tips if any
    if (qc.warnings.length > 0) {
        qc.warnings.forEach(w => {
            state.feedback.tips.unshift('‚ö†Ô∏è ' + w.msg);
        });
        state.feedback.tips = state.feedback.tips.slice(0, 6);
    }

    render();
    setTimeout(() => { const el = document.getElementById('feedbackPanel'); if (el) el.scrollIntoView({ behavior: 'smooth' }); }, 100);
}

function toggleSample() {
    state.showSample = !state.showSample; render();
    if (state.showSample) setTimeout(() => { const el = document.getElementById('samplePanel'); if (el) el.scrollIntoView({ behavior: 'smooth' }); }, 100);
}
function printPage() { window.print(); }

render();
</script>
</body>
</html>
